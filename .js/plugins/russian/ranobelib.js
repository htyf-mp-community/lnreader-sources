"use strict";var e=this&&this.__awaiter||function(e,l,a,t){return new(a||(a=Promise))((function(u,r){function i(e){try{v(t.next(e))}catch(e){r(e)}}function n(e){try{v(t.throw(e))}catch(e){r(e)}}function v(e){var l;e.done?u(e.value):(l=e.value,l instanceof a?l:new a((function(e){e(l)}))).then(i,n)}v((t=t.apply(e,l||[])).next())}))},l=this&&this.__generator||function(e,l){var a,t,u,r,i={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]};return r={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function n(n){return function(v){return function(n){if(a)throw new TypeError("Generator is already executing.");for(;r&&(r=0,n[0]&&(i=0)),i;)try{if(a=1,t&&(u=2&n[0]?t.return:n[0]?t.throw||((u=t.return)&&u.call(t),0):t.next)&&!(u=u.call(t,n[1])).done)return u;switch(t=0,u&&(n=[2&n[0],u.value]),n[0]){case 0:case 1:u=n;break;case 4:return i.label++,{value:n[1],done:0};case 5:i.label++,t=n[1],n=[0];continue;case 7:n=i.ops.pop(),i.trys.pop();continue;default:if(!(u=i.trys,(u=u.length>0&&u[u.length-1])||6!==n[0]&&2!==n[0])){i=0;continue}if(3===n[0]&&(!u||n[1]>u[0]&&n[1]<u[3])){i.label=n[1];break}if(6===n[0]&&i.label<u[1]){i.label=u[1],u=n;break}if(u&&i.label<u[2]){i.label=u[2],i.ops.push(n);break}u[2]&&i.ops.pop(),i.trys.pop();continue}n=l.call(e,i)}catch(e){n=[6,e],t=0}finally{a=u=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:1}}([n,v])}}},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:1});var t=require("@libs/filterInputs"),u=require("@libs/fetch"),r=require("@libs/novelStatus"),i=require("cheerio"),n=a(require("dayjs")),v={1:r.NovelStatus.Ongoing,2:r.NovelStatus.Completed,3:r.NovelStatus.OnHiatus,4:r.NovelStatus.Cancelled},o=function(){function a(){var e=this;this.id="RLIB",this.name="RanobeLib",this.site="https://ranobelib.me",this.version="1.0.0",this.icon="src/ru/ranobelib/icon.png",this.ui=void 0,this.fetchImage=u.fetchFile,this.resolveUrl=function(l,a){return e.site+l+(e.ui?(a?"?":"&")+"ui="+e.ui:"")},this.filters={sort:{label:"Сортировка",value:"rate",options:[{label:"Рейтинг",value:"rate"},{label:"Имя",value:"name"},{label:"Просмотры",value:"views"},{label:"Дате добавления",value:"created_at"},{label:"Дате обновления",value:"last_chapter_at"},{label:"Количество глав",value:"chap_count"}],type:t.FilterTypes.Picker},order:{label:"Порядок",value:"desc",options:[{label:"По убыванию",value:"desc"},{label:"По возрастанию",value:"asc"}],type:t.FilterTypes.Picker},type:{label:"Тип",value:[],options:[{label:"Авторский",value:"14"},{label:"Английский",value:"13"},{label:"Китай",value:"12"},{label:"Корея",value:"11"},{label:"Фанфик",value:"15"},{label:"Япония",value:"10"}],type:t.FilterTypes.CheckboxGroup},format:{label:"Формат выпуска",value:{include:[],exclude:[]},options:[{label:"4-кома (Ёнкома)",value:"1"},{label:"В цвете",value:"4"},{label:"Веб",value:"6"},{label:"Вебтун",value:"7"},{label:"Додзинси",value:"3"},{label:"Сборник",value:"2"},{label:"Сингл",value:"5"}],type:t.FilterTypes.ExcludableCheckboxGroup},status:{label:"Статус перевода",value:[],options:[{label:"Продолжается",value:"1"},{label:"Завершен",value:"2"},{label:"Заморожен",value:"3"},{label:"Заброшен",value:"4"}],type:t.FilterTypes.CheckboxGroup},manga_status:{label:"Статус тайтла",value:[],options:[{label:"Онгоинг",value:"1"},{label:"Завершён",value:"2"},{label:"Анонс",value:"3"},{label:"Приостановлен",value:"4"},{label:"Выпуск прекращён",value:"5"}],type:t.FilterTypes.CheckboxGroup},genres:{label:"Жанры",value:{include:[],exclude:[]},options:[{label:"Арт",value:"32"},{label:"Безумие",value:"91"},{label:"Боевик",value:"34"},{label:"Боевые искусства",value:"35"},{label:"Вампиры",value:"36"},{label:"Военное",value:"89"},{label:"Гарем",value:"37"},{label:"Гендерная интрига",value:"38"},{label:"Героическое фэнтези",value:"39"},{label:"Демоны",value:"81"},{label:"Детектив",value:"40"},{label:"Детское",value:"88"},{label:"Дзёсэй",value:"41"},{label:"Драма",value:"43"},{label:"Игра",value:"44"},{label:"Исекай",value:"79"},{label:"История",value:"45"},{label:"Киберпанк",value:"46"},{label:"Кодомо",value:"76"},{label:"Комедия",value:"47"},{label:"Космос",value:"83"},{label:"Магия",value:"85"},{label:"Махо-сёдзё",value:"48"},{label:"Машины",value:"90"},{label:"Меха",value:"49"},{label:"Мистика",value:"50"},{label:"Музыка",value:"80"},{label:"Научная фантастика",value:"51"},{label:"Омегаверс",value:"77"},{label:"Пародия",value:"86"},{label:"Повседневность",value:"52"},{label:"Полиция",value:"82"},{label:"Постапокалиптика",value:"53"},{label:"Приключения",value:"54"},{label:"Психология",value:"55"},{label:"Романтика",value:"56"},{label:"Самурайский боевик",value:"57"},{label:"Сверхъестественное",value:"58"},{label:"Сёдзё",value:"59"},{label:"Сёдзё-ай",value:"60"},{label:"Сёнэн",value:"61"},{label:"Сёнэн-ай",value:"62"},{label:"Спорт",value:"63"},{label:"Супер сила",value:"87"},{label:"Сэйнэн",value:"64"},{label:"Трагедия",value:"65"},{label:"Триллер",value:"66"},{label:"Ужасы",value:"67"},{label:"Фантастика",value:"68"},{label:"Фэнтези",value:"69"},{label:"Школа",value:"70"},{label:"Эротика",value:"71"},{label:"Этти",value:"72"},{label:"Юри",value:"73"},{label:"Яой",value:"74"}],type:t.FilterTypes.ExcludableCheckboxGroup},tags:{label:"Теги",value:{include:[],exclude:[]},options:[{label:"Авантюристы",value:"328"},{label:"Антигерой",value:"176"},{label:"Бессмертные",value:"333"},{label:"Боги",value:"218"},{label:"Борьба за власть",value:"309"},{label:"Брат и сестра",value:"360"},{label:"Ведьма",value:"339"},{label:"Видеоигры",value:"204"},{label:"Виртуальная реальность",value:"214"},{label:"Владыка демонов",value:"349"},{label:"Военные",value:"198"},{label:"Воспоминания из другого мира",value:"310"},{label:"Выживание",value:"212"},{label:"ГГ женщина",value:"294"},{label:"ГГ имба",value:"292"},{label:"ГГ мужчина",value:"295"},{label:"ГГ не ояш",value:"325"},{label:"ГГ не человек",value:"331"},{label:"ГГ ояш",value:"326"},{label:"Главный герой бог",value:"324"},{label:"Глупый ГГ",value:"298"},{label:"Горничные",value:"171"},{label:"Гуро",value:"306"},{label:"Гяру",value:"197"},{label:"Демоны",value:"157"},{label:"Драконы",value:"313"},{label:"Древний мир",value:"317"},{label:"Зверолюди",value:"163"},{label:"Зомби",value:"155"},{label:"Исторические фигуры",value:"323"},{label:"Кулинария",value:"158"},{label:"Культивация",value:"161"},{label:"ЛГБТ",value:"344"},{label:"ЛитРПГ",value:"319"},{label:"Лоли",value:"206"},{label:"Магия",value:"170"},{label:"Машинный перевод",value:"345"},{label:"Медицина",value:"159"},{label:"Межгалактическая война",value:"330"},{label:"Монстр Девушки",value:"207"},{label:"Монстры",value:"208"},{label:"Мрачный мир",value:"316"},{label:"Музыка",value:"358"},{label:"Музыка",value:"209"},{label:"Ниндзя",value:"199"},{label:"Обратный Гарем",value:"210"},{label:"Офисные Работники",value:"200"},{label:"Пираты",value:"341"},{label:"Подземелья",value:"314"},{label:"Политика",value:"311"},{label:"Полиция",value:"201"},{label:"Преступники / Криминал",value:"205"},{label:"Призраки / Духи",value:"196"},{label:"Призыватели",value:"329"},{label:"Прыжки между мирами",value:"321"},{label:"Путешествие в другой мир",value:"318"},{label:"Путешествие во времени",value:"213"},{label:"Рабы",value:"355"},{label:"Ранги силы",value:"312"},{label:"Реинкарнация",value:"154"},{label:"Самураи",value:"202"},{label:"Скрытие личности",value:"315"},{label:"Средневековье",value:"174"},{label:"Традиционные игры",value:"203"},{label:"Умный ГГ",value:"303"},{label:"Характерный рост",value:"332"},{label:"Хикикомори",value:"167"},{label:"Эволюция",value:"322"},{label:"Элементы РПГ",value:"327"},{label:"Эльфы",value:"217"},{label:"Якудза",value:"165"}],type:t.FilterTypes.ExcludableCheckboxGroup},require_chapters:{label:"Только проекты с главами",value:1,type:t.FilterTypes.Switch}}}return a.prototype.popularNovels=function(a,t){var r,n,v,o,s,b=t.showLatestNovels,c=t.filters;return e(this,void 0,void 0,(function(){var e,t,h,d,p=this;return l(this,(function(l){switch(l.label){case 0:return e=this.site+"/manga-list?sort=",e+=b?"last_chapter_at":(null===(r=null==c?void 0:c.sort)||void 0===r?void 0:r.value)||"rate",e+="&dir="+((null===(n=null==c?void 0:c.order)||void 0===n?void 0:n.value)||"desc"),e+="&chapters[min]="+((null===(v=null==c?void 0:c.require_chapters)||void 0===v?void 0:v.value)?"1":"0"),Object.entries(c||{}).forEach((function(l){var a=l[0],t=l[1].value;t instanceof Array&&t.length&&(e+="&"+a+"[]="+t.join("&"+a+"[]=")),(null==t?void 0:t.include)instanceof Array&&t.include.length&&(e+="&"+a+"[include][]="+t.include.join("&"+a+"[include][]=")),(null==t?void 0:t.exclude)instanceof Array&&t.exclude.length&&(e+="&"+a+"[exclude][]="+t.exclude.join("&"+a+"[exclude][]="))})),e+="&page="+a,[4,(0,u.fetchApi)(e).then((function(e){return e.text()}))];case 1:return t=l.sent(),h=(0,i.load)(t),this.ui=null===(s=null===(o=h("a.header-right-menu__item").attr("href"))||void 0===o?void 0:o.replace)||void 0===s?void 0:s.call(o,/[^0-9]/g,""),d=[],h(".media-card-wrap").each((function(e,l){var a=h(l).find(".media-card__title").text(),t=h(l).find("a.media-card").attr("data-src"),u=h(l).find("a.media-card").attr("href");u&&d.push({name:a,cover:t,path:u.replace(p.site,"")})})),[2,d]}}))}))},a.prototype.parseNovel=function(a){var t,o,s,b,c,h,d,p;return e(this,void 0,void 0,(function(){var e,f,m,_,g,y,x,w,N;return l(this,(function(l){switch(l.label){case 0:return[4,(0,u.fetchApi)(this.resolveUrl(a,1)).then((function(e){return e.text()}))];case 1:if(e=l.sent(),f=(0,i.load)(e),(m={path:a,name:(null===(o=null===(t=f(".media-name__main").text())||void 0===t?void 0:t.trim)||void 0===o?void 0:o.call(t))||""}).cover=f(".container_responsive img").attr("src"),m.summary=f(".media-description__text").text().trim(),m.genres=f('div[class="media-tags"]').text().trim().replace(/[\n\r]+/g,", ").replace(/  /g,""),f('div[class="media-info-list paper"] > [class="media-info-list__item"]').each((function(){var e=f(this).find('div[class="media-info-list__title"]').text();"Автор"===e?m.author=f(this).find('div[class="media-info-list__value"]').text().trim():"Художник"===e&&(m.artist=f(this).find('div[class="media-info-list__value"]').text().trim())})),this.ui=null===(b=null===(s=f("a.header-right-menu__item").attr("href"))||void 0===s?void 0:s.replace)||void 0===b?void 0:b.call(s,/[^0-9]/g,""),(_=e.match(/window\.__DATA__ = ({.*?});/))instanceof Array&&_.length>=2){if(g=JSON.parse(_[1]),m.name||(m.name=g.manga.rusName||g.manga.engName||g.manga.name),m.status=v[g.manga.status]||r.NovelStatus.Unknown,this.ui=null===(c=null==g?void 0:g.user)||void 0===c?void 0:c.id,!(null===(h=g.chapters.list)||void 0===h?void 0:h.length))return[2,m];y=g.chapters.list.length,x={},w={},(null===(d=g.chapters.branches)||void 0===d?void 0:d.length)&&g.chapters.branches.length>1&&(g.chapters.branches.forEach((function(e){var l,a=e.teams,t=e.id;(null==a?void 0:a.length)&&(x[t||0]=(null===(l=a.find((function(e){return e.is_active})))||void 0===l?void 0:l.name)||a[0].name)})),g.chapters.list.forEach((function(e){e.index=w[e.branch_id||0]||1,w[e.branch_id||0]=(w[e.branch_id||0]||1)+1}))),N=[],g.chapters.list.forEach((function(e,l){return N.push({name:"Том "+e.chapter_volume+" Глава "+e.chapter_number+(e.chapter_name?" "+e.chapter_name.trim():""),path:a+"/v"+e.chapter_volume+"/c"+e.chapter_number+"?bid="+(e.branch_id||""),releaseTime:(0,n.default)(e.chapter_created_at).format("LLL"),chapterNumber:w[e.branch_id||0]-(e.index||0)||y-l,page:x[e.branch_id||0]||"Основной перевод"})})),m.chapters=(null===(p=g.chapters.branches)||void 0===p?void 0:p.length)&&g.chapters.branches.length>1?N.sort((function(e,l){return(e.page||0)>(l.page||0)?1:(e.page||0)<(l.page||0)?-1:(e.chapterNumber||0)-(l.chapterNumber||0)})):N.reverse()}return[2,m]}}))}))},a.prototype.parseChapter=function(a){return e(this,void 0,void 0,(function(){var e,t,r=this;return l(this,(function(l){switch(l.label){case 0:return[4,(0,u.fetchApi)(this.resolveUrl(a)).then((function(e){return e.text()}))];case 1:return e=l.sent(),(t=(0,i.load)(e))(".reader-container img").each((function(e,l){var a=t(l).attr("data-src")||t(l).attr("src");(null==a?void 0:a.startsWith("http"))?t(l).attr("src",a):t(l).attr("src",r.site+a),t(l).removeAttr("data-src")})),[2,t(".reader-container").html()||""]}}))}))},a.prototype.searchNovels=function(a){return e(this,void 0,void 0,(function(){var e,t;return l(this,(function(l){switch(l.label){case 0:return[4,(0,u.fetchApi)(this.site+"/search?q="+a+"&type=manga")];case 1:return[4,l.sent().json()];case 2:return e=l.sent(),t=[],e.forEach((function(e){return t.push({name:e.rus_name||e.name,cover:e.coverImage,path:"/"+e.slug})})),[2,t]}}))}))},a}();exports.default=new o;